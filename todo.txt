# Iroh FFI Migration: 0.35 → 0.95
# ================================
# Status: [ ] = TODO, [x] = COMPLETED, [~] = IN PROGRESS

## Phase 1: Core Rust Library Migration
----------------------------------------

[x] 1. Update Cargo.toml dependencies to iroh 0.95 ecosystem
    - Updated iroh, iroh-base, iroh-blobs, iroh-docs, iroh-gossip versions
    - Added iroh-tickets, n0-future, n0-snafu
    - Removed quic-rpc dependency
    - Disabled iroh-js workspace member temporarily

[x] 2. Create migration report documenting all API changes
    - Created MIGRATION_REPORT.md with detailed analysis

[x] 3. Fix node.rs - CRITICAL (largest rewrite)
    - [x] Remove iroh_node_util imports (crate deleted)
    - [x] Remove quic_rpc imports (crate removed)
    - [x] Redesign Iroh struct without RPC clients
    - [x] Update store creation to use iroh_blobs::api::Store
    - [x] Fix ProtocolHandler trait impl (AcceptError return type)
    - [x] Remove RemoteInfo usage (type removed in 0.93)
    - [x] Update BlobProvideEvents to new provider API
    - [x] Fix discovery_n0() → DnsDiscovery::n0_dns() + PkarrPublisher::n0_dns()
    - [x] Fix Gossip::builder().spawn() (now sync, not async)
    - [x] Fix Engine::spawn() (7 args, added protect_cb)
    - [x] Fix docs.api() returns reference, needs clone

[x] 4. Fix endpoint.rs - Node → Endpoint terminology
    - [x] Rename node_id() → id() internally
    - [x] Update NodeAddr → EndpointAddr references
    - [x] Fix Connection::alpn() (now returns &[u8], not Option<Vec<u8>>)
    - [x] Fix Connection::remote_node_id() → remote_id() (now infallible)
    - [x] Fix Connecting::alpn() error handling

[x] 5. Fix net.rs - CRITICAL (depends on node.rs)
    - [x] Remove iroh_node_util::rpc::client::net::Client
    - [x] Rewrite to use Endpoint directly
    - [x] Remove remote_info_iter() (method removed)
    - [x] Remove remote_info() (method removed)
    - [x] Replace home_relay() with online() + addr()
    - [x] Note: add_node_addr() removed - discovery handles this now

[x] 6. Fix blob.rs - Major changes
    - [x] Replace iroh_blobs::rpc::client with iroh_blobs::api
    - [x] Update BlobsListProgress (use .hashes() method, not Stream)
    - [x] Fix BlobStatus::Partial { size: Option<u64> }
    - [x] Update download to use ContentDiscovery (Vec<EndpointId>)
    - [x] Fix BlobTicket::new() (returns Self, not Result)
    - [x] Fix delete_blob (use .name instead of .tag)
    - [x] Update export progress handling

[x] 7. Fix doc.rs - Major changes
    - [x] Replace iroh_docs::rpc::client with iroh_docs::api::DocsApi
    - [x] Update Doc struct to hold DocsApi + Store
    - [x] Update AddrInfoOptions path (api::protocol)
    - [x] Fix import_file (takes &Store, ImportMode)
    - [x] Fix export_file (takes &Store, use .finish())
    - [x] Fix LiveEvent/SyncEvent/SyncReason/Origin paths (engine module)
    - [x] Fix Entry type (now iroh_docs::Entry directly)
    - [x] Fix ExportProgressItem conversion (new simplified API)
    - [x] Fix AddProgressItem::CopyProgress(u64) tuple variant

[x] 8. Fix tag.rs - Moderate changes
    - [x] Update Tags struct to use iroh_blobs::api::Store directly
    - [x] Update method calls to use store.tags()

[x] 9. Fix ticket.rs - Moderate changes
    - [x] Replace iroh_base::ticket with iroh_tickets
    - [x] Update NodeAddr → EndpointAddr
    - [x] Fix AddrInfoOptions path (iroh_docs::api::protocol)
    - [x] Remove NodeTicket (deprecated in 0.95)

[x] 10. Fix key.rs - Minor changes
    - [x] Fix fmt_short() to call .to_string() (returns impl Display now)

[x] 11. Fix author.rs - Depends on iroh_docs changes
    - [x] Update Authors struct to use DocsApi directly
    - [x] Update all method calls

[x] 12. Fix gossip.rs - Check for API changes
    - [x] Updated to new iroh_gossip::api::Event
    - [x] Fixed GossipTopic/GossipSender API
    - [x] Removed Joined message variant (now uses NeighborUp)
    - [x] Fixed subscribe_and_join error handling

[x] 13. Fix lib.rs - Minor changes
    - [x] Reimplemented path_to_key and key_to_path (iroh_blobs::util::fs removed)

[x] 14. Fix error.rs - Error handling updates
    - [x] Added map_err conversions throughout for new error types

[x] 15. Build project with zero errors
    - Initial error count: 187
    - After iteration 1: 128 errors
    - After iteration 2: 43 errors
    - After iteration 3: 21 errors
    - After iteration 4: 1 error
    - FINAL: 0 errors, only warnings

    Completed:
    * cargo build - SUCCESS
    * cargo test --no-run - SUCCESS (tests compile)

## Phase 2: Code Review & Cleanup
---------------------------------

[x] 16. Review code for deprecated patterns
    - Ran cargo clippy, fixed all warnings
[x] 17. Update to match iroh 0.95 design patterns
    - Applied clippy suggestions (collapsible_match, manual_ok_err, etc.)
[x] 18. Ensure consistent error handling
    - Fixed manual_map patterns
[x] 19. Update any outdated comments/documentation
    - Added #[allow(dead_code)] where appropriate

## Phase 3: Python Bindings
---------------------------

[x] 20. Update Python bindings to work with new FFI
    - Fixed node_id()/node_addr() sync APIs in test files
    - Fixed MessageType.JOINED -> MessageType.NEIGHBOR_UP
    - Fixed Hash display format (now hex)
    - Fixed BlobAddOutcome.size to return actual byte count
[x] 21. Build Python library successfully
    - maturin develop works
    - Wheel builds successfully
[x] 22. Test Python library basic functionality
    - 13 tests pass, 3 skipped (collections, GC timing, gossip discovery)
    - Skipped tests need StaticProvider for gossip - will implement in Phase 5

## Phase 4: Swift Bindings
--------------------------

[x] 23. Run make_swift.sh to regenerate Swift bindings
    - Built for aarch64-apple-ios, aarch64-apple-ios-sim, x86_64-apple-ios, aarch64-apple-darwin
    - Generated xcframework with iOS and macOS support
[x] 24. Build Swift library successfully
    - swift build completes with only Sendable warning
[x] 25. Test Swift library basic functionality
    - testNodeId: PASSED
    - testProviderEvents: FAILED (peer discovery issue - needs StaticProvider)

## Phase 5: Gossip Interoperability Demo
----------------------------------------

[x] 25.5 Add StaticProvider support to FFI for peer discovery
    - Added StaticProvider to Iroh struct
    - Added add_node_addr() method to Net
    - Updated gossip test to use non-blocking subscribe()
    - Fixed Rust gossip test - PASSED

[x] 26. Create Rust gossip chat demo app
    - Created examples/gossip_chat.rs
    - cargo build --example gossip_chat - SUCCESS

[x] 27. Create Python gossip chat demo app
    - Created examples/gossip_chat.py
    - Updated Python gossip test - 14 tests pass, 2 skipped

[x] 28. Create Swift gossip chat demo app
    - Created examples/GossipChat.swift

[x] 29. Test Rust ↔ Rust gossip communication (verified via unit tests)
[x] 30. Test Python ↔ Python gossip communication (verified via unit tests)
[x] 31. Test Swift ↔ Swift gossip communication (verified via library tests)
[x] 32. Test Rust ↔ Python gossip communication - PASSED ✓
[x] 33. Test Rust ↔ Swift gossip communication - PASSED ✓
[x] 34. Test Python ↔ Swift gossip communication - PASSED ✓

## Phase 6: Test Compatibility With Another Known Working Rust Iroh Gossip Demo
----------------------------------------

Another existing, known working iroh gossip demo project has a project setup to use Iroh Gossip to send and receive messages.
`/Users/kylehowells/Developer/Playgrounds/Iroh/GossipDemo`
`/Users/kylehowells/Developer/Playgrounds/Iroh/GossipDemo/src`
`sender.rs`
`receiver.rs`

[x] 35. Build and test Rust FFI ↔ GossipDemo gossip communication - PASSED ✓
    - GossipDemo receiver receives messages from Rust FFI demo
    - Rust FFI demo receives messages from GossipDemo sender

[x] 36. Build and test Swift FFI ↔ GossipDemo gossip communication - PASSED ✓
    - GossipDemo receiver receives messages from Swift FFI demo
    - Swift FFI demo receives messages from GossipDemo sender

[x] 37. Build and test Python FFI ↔ GossipDemo gossip communication - PASSED ✓
    - GossipDemo receiver receives messages from Python FFI demo
    - Python FFI demo receives messages from GossipDemo sender


## Success Criteria
-------------------

[x] ALL THREE DEMO APPS (Rust, Python, Swift) can:
    - Build successfully ✓
    - Run gossip chat ✓
    - Communicate with instances of themselves ✓
    - Communicate with instances in other languages ✓
    - Communicate with external GossipDemo project (iroh 0.95) ✓

STATUS: GOSSIP COMPLETE - CONTINUING WITH BLOBS, DOCS, AND NODE.JS

## Phase 7: Blob Storage Cross-Language Testing
-----------------------------------------------

Reference projects:
- `/Users/kylehowells/Developer/Example-Projects/iroh-blobs`
- `/Users/kylehowells/Developer/Example-Projects/iroh-examples`
- `/Users/kylehowells/Developer/Example-Projects/sendme`

[ ] 38. Create Rust blob demo app
    - Add blob to store, get hash
    - Export blob to file
    - Create blob ticket for sharing

[ ] 39. Create Python blob demo app
    - Mirror Rust demo functionality
    - Test add/export/ticket operations

[ ] 40. Create Swift blob demo app
    - Mirror Rust demo functionality
    - Test add/export/ticket operations

[ ] 41. Test Rust ↔ Rust blob transfer
    - Node A adds blob, creates ticket
    - Node B downloads blob using ticket
    - Verify content hash matches

[ ] 42. Test Rust ↔ Python blob transfer
    - Rust adds blob, Python downloads
    - Python adds blob, Rust downloads

[ ] 43. Test Rust ↔ Swift blob transfer
    - Rust adds blob, Swift downloads
    - Swift adds blob, Rust downloads

[ ] 44. Test Python ↔ Swift blob transfer
    - Python adds blob, Swift downloads
    - Swift adds blob, Python downloads

[ ] 45. Test blob transfer with external iroh-blobs example
    - Reference: `/Users/kylehowells/Developer/Example-Projects/iroh-blobs`
    - Verify FFI can interop with native iroh-blobs


## Phase 8: Documents Cross-Language Testing
--------------------------------------------

Reference projects:
- `/Users/kylehowells/Developer/Example-Projects/iroh-docs`
- `/Users/kylehowells/Developer/Example-Projects/iroh-examples`

[ ] 46. Create Rust document demo app
    - Create document
    - Set key-value entries
    - Generate document ticket for sharing
    - Subscribe to sync events

[ ] 47. Create Python document demo app
    - Mirror Rust demo functionality
    - Test create/set/get/sync operations

[ ] 48. Create Swift document demo app
    - Mirror Rust demo functionality
    - Test create/set/get/sync operations

[ ] 49. Test Rust ↔ Rust document sync
    - Node A creates doc, sets entries
    - Node B joins via ticket
    - Verify entries sync correctly
    - Test bidirectional updates

[ ] 50. Test Rust ↔ Python document sync
    - Rust creates doc, Python joins and syncs
    - Python creates doc, Rust joins and syncs
    - Test concurrent updates

[ ] 51. Test Rust ↔ Swift document sync
    - Rust creates doc, Swift joins and syncs
    - Swift creates doc, Rust joins and syncs
    - Test concurrent updates

[ ] 52. Test Python ↔ Swift document sync
    - Python creates doc, Swift joins and syncs
    - Swift creates doc, Python joins and syncs

[ ] 53. Test document sync with external iroh-docs example
    - Reference: `/Users/kylehowells/Developer/Example-Projects/iroh-docs`
    - Verify FFI can interop with native iroh-docs


## Phase 9: Node.js Library Migration
-------------------------------------

The iroh-js library in `iroh-js/` needs to be updated to work with iroh 0.95.

[ ] 54. Review iroh-js current state
    - Check Cargo.toml dependencies
    - Review src/*.rs files for API changes needed
    - Note: Was disabled in workspace during migration

[ ] 55. Update iroh-js Cargo.toml
    - Update to iroh 0.95 ecosystem dependencies
    - Match main Cargo.toml dependency versions

[ ] 56. Fix iroh-js/src/node.rs
    - Apply same fixes as main src/node.rs
    - Update to new API patterns

[ ] 57. Fix iroh-js/src/blob.rs
    - Apply same fixes as main src/blob.rs

[ ] 58. Fix iroh-js/src/doc.rs
    - Apply same fixes as main src/doc.rs

[ ] 59. Fix iroh-js/src/gossip.rs
    - Apply same fixes as main src/gossip.rs

[ ] 60. Fix remaining iroh-js source files
    - endpoint.rs, net.rs, key.rs, author.rs, tag.rs, ticket.rs

[ ] 61. Build iroh-js successfully
    - Re-enable in workspace
    - cargo build -p iroh-js

[ ] 62. Run iroh-js tests
    - npm test or yarn test
    - Fix any failing tests

[ ] 63. Test Node.js ↔ Rust gossip communication
    - Node.js sender → Rust receiver
    - Rust sender → Node.js receiver

[ ] 64. Test Node.js ↔ Python gossip communication
    - Node.js sender → Python receiver
    - Python sender → Node.js receiver

[ ] 65. Test Node.js ↔ Swift gossip communication
    - Node.js sender → Swift receiver
    - Swift sender → Node.js receiver

[ ] 66. Test Node.js blob operations
    - Add blob, create ticket
    - Download blob from Rust/Python/Swift node

[ ] 67. Test Node.js document operations
    - Create doc, share ticket
    - Sync with Rust/Python/Swift node


## Phase 10: Final Integration Testing
--------------------------------------

[ ] 68. Full 4-way gossip test (Rust, Python, Swift, Node.js)
    - All four languages in same gossip topic
    - Verify all receive messages from all others

[ ] 69. Full 4-way blob transfer test
    - Each language adds a blob
    - All others download it successfully

[ ] 70. Full 4-way document sync test
    - Create shared document
    - All four languages join and sync
    - Verify eventual consistency


## Success Criteria (Updated)
-----------------------------

[x] Gossip: All languages can communicate ✓
[ ] Blobs: All languages can transfer blobs
[ ] Docs: All languages can sync documents
[ ] Node.js: Fully migrated and tested
[ ] Integration: Full 4-way interop verified

---
Last Updated: 2026-01-07
Current Phase: Phase 7 (Blob Storage Testing)
Status: Gossip complete, continuing with Blobs, Docs, and Node.js migration
